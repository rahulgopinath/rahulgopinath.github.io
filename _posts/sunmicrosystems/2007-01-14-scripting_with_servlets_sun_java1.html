---
layout: post
category : blog
tagline: "."
tags : [sunmicrosystems blog sun]
e: Scripting with servlets [jruby]  - part I  (Sun Java System WebServer 7.0)
---
{% raw %}
<div class="entry" id="scripting_with_servlets_sun_java1">

	<h3 class="entry-title">
			Scripting with servlets [jruby]  - part I  (Sun Java System WebServer 7.0)
	    </h3>

    <h4 class="entry-meta">By blue on <a href="#">Jan 14, 2007</a>
</h4>

    <div class="entry-body">
                                        	Writing Jruby servlets on Sun Java System WebServer 7.0. <br><h3>Prior work:<br>
</h3>
<p>Jruby already has an <a href="http://www.nabble.com/RubyServlet-t2915413.html" title="jruby servlet implementation by Marcin Mielżyński"><span style="text-decoration: underline;">implementation</span></a> of servlets by  &lt;script&gt;document.write('<a href="%5C%5C%22'" rel='\\"nofollow\\"' target='\\"_top\\"'>');</a><a href="http://blogs.sun.com/user/UserProfile.jtp?user=431520" rel="nofollow" target="_top"></a><a target="_top" rel="nofollow" href="http://blogs.sun.com/user/UserProfile.jtp?user=431520"></a><a href="http://blogs.sun.com/user/UserProfile.jtp?user=431520" rel="nofollow" target="_top"></a><a target="_top" rel="nofollow" href="http://blogs.sun.com/user/UserProfile.jtp?user=431520"></a><a href="http://blogs.sun.com/user/UserProfile.jtp?user=431520" rel="nofollow" target="_top"></a><a target="_top" rel="nofollow" href="http://blogs.sun.com/user/UserProfile.jtp?user=431520"></a><a href="http://blogs.sun.com/user/UserProfile.jtp?user=431520" rel="nofollow" target="_top"></a><a target="_top" rel="nofollow" href="http://www.nabble.com/user/UserProfile.jtp?user=431520">Marcin Mielżyński</a><br>It has these features:<br></p>
<ol>
<li>Loosely based on PyServlet (servlet implementation for jython)</li>
<li>Mimics RailsControllers</li>
<li>Offers three kinds of servlets</li>
</ol>
<p>                  StatefullServlet that behaves like Rails controller (if instantiated every request)<br>                  StatelessServlet that behaves like standard stateless Java servlet<br>                  SessionServlet - is kept transparently in session (is its instance 
variables are not shared between sessions) 
<br></p>
<p> How ever it also has these features that I did not like <br></p>
<ol><li>Too Rails oriented.          </li></ol>
<ul><li>Servlets in ruby should be preferably similar to java servlets rather than look like Rails</li></ul>
<li>Does too many things in java.</li>
<ul><li>We should do only the basic framework in java and delegate the rest to the ruby world. This way a programmer who<br>is more comfortable in ruby will be able to implement any feature that he wants with out being impeded by <br>the implementation of our servlet code in java. More over, the code in java generally becomes immutable once it <br>gets compiled and added into a jar.<br>
</li></ul>
<p>It would be much more nicer to delegate the responsibility of doing these things to the handler in ruby rather than to do it in java.<br>This would allow the possibility of allowing the programmer to construct different varieties of handler servlets in ruby itself during<br>the development with out touching the java code (compiling and jar-ing)<br></p>
<h3>Our approach.<br>
</h3>
<p>Making use of the ScriptServlet developed in the previous <a title="Scripting servlets with Sun Java System WebServer 7.0" target="_blank" href="http://blogs.sun.com/blue/entry/scripting_with_servlets_sun_java">entry</a>, we create a simple class that provides necessary initialization<br>and evaluation primitives. <br> <br></p>
<table width="675" height="88" cellspacing="1" cellpadding="1" border="1" align="center"><tbody><tr><td style="width: 100%;"><p><font size="2" color="#8e2020">package com.sun.servlet;<br><br>import javax.servlet.http.\*;<br><br>import org.jruby.\*;<br>import org.jruby.ast.Node;<br>import org.jruby.javasupport.JavaUtil;<br>import org.jruby.runtime.builtin.IRubyObject;<br><br>public class RubyServlet extends ScriptServlet {<br>    public static IRuby jr = Ruby.getDefaultInstance();<br><br>    public void initialize(String handler, Object code) throws Exception {<br>        jr.getLoadService().require("java");<br>        Node script = jr.parse((String)code, handler, jr.getCurrentContext().getCurrentScope());<br>        // The script file returns a single proc with arity 1<br>        ((RubyProc)jr.eval(script)).call(new IRubyObject[] {wrap(this)});<br>    }<br><br>    protected IRubyObject wrap(Object object) {<br>        IRubyObject result = JavaUtil.convertJavaToRuby(jr, object);<br>        return jr.getModule("JavaUtilities").callMethod(jr.getCurrentContext(), "wrap", result);<br>    }<br><br>    public void eval(Object fn, HttpServletRequest request,  HttpServletResponse response) {<br>        if (request == null)<br>            ((RubyProc)fn).call(new IRubyObject[0]);<br>        else<br>            ((RubyProc)fn).call(new IRubyObject[] {wrap(request), wrap(response)});<br>    }<br>}<br></font></p></td></tr></tbody></table>
<p> </p>
<p>Here we use the <b>initialize</b> method to read in the handler specified, and executes it. The handler (which is in ruby) is responsible<br>for specifying the behavior of our servlet. It specifies which HTTP methods are supported, and how the Request URI is interpreted.<br></p>
<p>The <b>eval</b> method provides a way for the scripts that are in place for HTTP method processing to be executed by the ScriptServlet.<br></p>
<h2>The Ruby Dimension<br>
</h2>
<h3>Jvm Bindings for jruby.</h3>
<p>Jruby allows us to access the methods of a class or instance the same way as that of java, by using the 'dot' notation.<br>Thus to print something to the stdout, we can use the statement<br></p>
<p><font size="2" color="#0f11ff"> System.out.println 'my string'</font><br></p>
<p> with the jruby correctly invoking System.out.println in java.<br></p>
<p> Thus our handler can be written as below.</p>
<p><b>docroot/WEB-INF/code/ruby.rb</b><br></p>
<table width="675" height="88" cellspacing="1" cellpadding="1" border="1" align="center"><tbody><tr><td style="width: 100%;"><p><font size="2" color="#8e2020">proc {|httpservlet|<br>    do_get = proc {|request,response|<br>        out = response.getWriter<br>        response.setContentType "text/html"<br><br>        begin<br>            spath = request.getServletPath<br>            filename = httpservlet.getServletConfig.getServletContext.getRealPath(spath)<br>            out.println eval(httpservlet.read(filename))<br>        rescue Exception =&gt; e<br>            out.println %{&lt;html&gt;&lt;body&gt;&lt;b&gt;Servlet Error (#{e.message})&lt;/b&gt;&lt;xmp&gt; <br>                   #{e.backtrace}<br>                   &lt;/xmp&gt;&lt;/body&gt;&lt;/html&gt;}<br>        end<br>    }<br>    httpservlet.add('get', do_get)<br>    httpservlet.add('post', do_get)<br>}<br></font></p></td></tr></tbody></table>
<p> </p>
<p>We return a proc object with an arity 1 to the evaluator. This is done to allow the servlet initializer to pass the<br>httpservlet object as an arguement. We could also have bound the httpservlet to a global variable.<br></p>
<p>Inside the larger anonymous proc, we define a second proc for do_get, and bind it to the 'get' and 'post' methods of httpservlet.<br>these procs take request and response as the arguments. They extract the name of the script and load and evaluate the script<br>referenced.  The script that gets evaluated has complete access to the variables request, response, out and httpservlet just like<br>a normal java servlet or a jsp page.Any exceptions are printed to the response output stream. </p>
<p>A simple ruby script that may be loaded by this handler will look like this.</p>
<p><b>/docroot/hello.rb</b> </p>
<table width="675" height="88" cellspacing="1" cellpadding="1" border="1" align="center">
<tbody><tr><td style="width: 100%;"><p><font size="2" color="#8e2020">def myhello<br>     return %{&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;abc&lt;/title&gt;&lt;/head&gt;<br>  &lt;body&gt;<br>   &lt;h1&gt; Hello at #{java.util.Date.new} from #{@request.getServletPath}&lt;/h1&gt;<br>  &lt;/body&gt;<br> &lt;/html&gt;}<br>end<br>myhello<br></font></p></td></tr></tbody>
</table>
<h3>Build  Steps. </h3>
<p>          A complete webapp is provided <a href="http://blogs.sun.com/blue/resource/servlets/jruby-webapp.tar.gz" title="jruby-webapp">here</a>. You can download it and extract the contents to a<br>directory called 'jruby' inside your installation. In order for the build.xml to work, It should be in<br>the <b>samples/java/webapps/jruby</b> directory in your installation of webserver.<br></p>
<p>It also contains the jruby.jar in the WEB-INF/lib, which should be replaced with the latest<br>jruby.jar if necessary.<br></p>
<p>Your extracted directory will look like this.</p>
<p><font size="2" color="#473f42">|cd jruby<br>|find .<br>./docs<br>./docs/index.html<br>./src<br>./src/build.xml<br>./src/RubyServlet.java<br>./src/docroot<br>./src/docroot/WEB-INF<br>./src/docroot/WEB-INF/lib<br>./src/docroot/WEB-INF/lib/jruby.jar<br>./src/docroot/WEB-INF/web.xml<br>./src/docroot/WEB-INF/sun-web.xml<br>./src/docroot/WEB-INF/code<br>./src/docroot/WEB-INF/code/ruby.rb<br>./src/docroot/index.html<br>./src/docroot/hello.rb<br>./src/ScriptServlet.java<br>./deploy.tcl</font> </p>
<p><br>You can run 'ant' from inside the src directory which will create the jruby-webapp.war in the<br>jruby directory. This war file can be deployed on the webserver using the wadm.<br></p>
<p><font size="2" face="courier new,courier,monospace" color="#0f11ff">wadm </font><font size="2" face="courier new,courier,monospace" color="#0f11ff"> -u admin</font><font size="2" face="courier new,courier,monospace" color="#0f11ff"> -f deploy.tcl</font><br></p>
<p> Once the deployment goes through, you will be able to access the ruby file using the url</p>
<p><font size="2" color="#0003ff">http://yourserver:port/jruby/hello.rb</font><br> </p>
        
    </div>

    <div class="entry-footer">
        <p class="entry-category">Category: scripting</p>
        <p class="entry-tags">Tags:    
    	    <a href="https://blogs.oracle.com/blue/tags/jruby" rel="tag">jruby</a> 
  	    <a href="https://blogs.oracle.com/blue/tags/scripting" rel="tag">scripting</a> 
  	    <a href="https://blogs.oracle.com/blue/tags/servlet" rel="tag">servlet</a> 
  	    <a href="https://blogs.oracle.com/blue/tags/sun_java_system_webserver" rel="tag">sun_java_system_webserver</a> 
    
 </p>
        <p class="entry-links">
        <a href="https://blogs.oracle.com/blue/entry/scripting_with_servlets_sun_java1">Permanent link to this entry</a>
                        </p>
    </div>

	    
	</div>
{% endraw %}
