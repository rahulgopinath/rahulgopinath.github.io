<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
<title>Create ICS Calendar Invite</title>
<style>
</style>
<script
  defer src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</head>
<body>
    <div id="container" class="container">
<H2>Create ICS Calendar Invite</H2>

<style>
        .form-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group label {
            flex: 1;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            flex: 2;
        }

        button, input[type="submit"] {
            margin: 10px 5px;
        }
    </style>

<form onsubmit="event.preventDefault(); generateICS();">
    <div class="form-group">
        <label for="eventName">Event Name:</label>
        <input type="text" id="eventName" required value="(Topic here)">
    </div>
    <div class="form-group">
        <label for="timezone">Time Zone:</label>
        <select id="timezone" required>
            <option value="UTC">UTC</option>
            <option value="Australia/Sydney">(GMT+10:00) Sydney</option>
            <option value="Asia/Kolkata">(GMT+5:30) Kolkata</option>
            <option value="Africa/Abidjan">(GMT+0:00) Abidjan</option>
            <option value="Africa/Accra">(GMT+0:00) Accra</option>
            <option value="Africa/Addis_Ababa">(GMT+3:00) Addis Ababa</option>
            <option value="Africa/Algiers">(GMT+1:00) Algiers</option>
            <option value="Africa/Cairo">(GMT+2:00) Cairo</option>
            <option value="Africa/Casablanca">(GMT+1:00) Casablanca</option>
            <option value="Africa/Johannesburg">(GMT+2:00) Johannesburg</option>
            <option value="Africa/Lagos">(GMT+1:00) Lagos</option>
            <option value="Africa/Nairobi">(GMT+3:00) Nairobi</option>
            <option value="America/Anchorage">(GMT-8:00) Anchorage</option>
            <option value="America/Argentina/Buenos_Aires">(GMT-3:00) Buenos Aires</option>
            <option value="America/Bogota">(GMT-5:00) Bogota</option>
            <option value="America/Caracas">(GMT-4:00) Caracas</option>
            <option value="America/Chicago">(GMT-5:00) Chicago</option>
            <option value="America/Denver">(GMT-6:00) Denver</option>
            <option value="America/Godthab">(GMT-2:00) Godthab</option>
            <option value="America/Halifax">(GMT-3:00) Halifax</option>
            <option value="America/Lima">(GMT-5:00) Lima</option>
            <option value="America/Los_Angeles">(GMT-7:00) Los Angeles</option>
            <option value="America/Mexico_City">(GMT-5:00) Mexico City</option>
            <option value="America/New_York">(GMT-4:00) New York</option>
            <option value="America/Phoenix">(GMT-7:00) Phoenix</option>
            <option value="America/Santiago">(GMT-4:00) Santiago</option>
            <option value="America/Sao_Paulo">(GMT-3:00) Sao Paulo</option>
            <option value="America/St_Johns">(GMT-2:30) St. John's</option>
            <option value="America/Toronto">(GMT-4:00) Toronto</option>
            <option value="America/Vancouver">(GMT-7:00) Vancouver</option>
            <option value="Asia/Baghdad">(GMT+3:00) Baghdad</option>
            <option value="Asia/Baku">(GMT+4:00) Baku</option>
            <option value="Asia/Bangkok">(GMT+7:00) Bangkok</option>
            <option value="Asia/Colombo">(GMT+5:30) Colombo</option>
            <option value="Asia/Dhaka">(GMT+6:00) Dhaka</option>
            <option value="Asia/Dubai">(GMT+4:00) Dubai</option>
            <option value="Asia/Hong_Kong">(GMT+8:00) Hong Kong</option>
            <option value="Asia/Istanbul">(GMT+3:00) Istanbul</option>
            <option value="Asia/Jakarta">(GMT+7:00) Jakarta</option>
            <option value="Asia/Jerusalem">(GMT+3:00) Jerusalem</option>
            <option value="Asia/Kabul">(GMT+4:30) Kabul</option>
            <option value="Asia/Karachi">(GMT+5:00) Karachi</option>
            <option value="Asia/Kathmandu">(GMT+5:45) Kathmandu</option>
            <option value="Asia/Kolkata">(GMT+5:30) Kolkata</option>
            <option value="Asia/Kuwait">(GMT+3:00) Kuwait</option>
            <option value="Asia/Manila">(GMT+8:00) Manila</option>
            <option value="Asia/Qatar">(GMT+3:00) Qatar</option>
            <option value="Asia/Riyadh">(GMT+3:00) Riyadh</option>
            <option value="Asia/Seoul">(GMT+9:00) Seoul</option>
            <option value="Asia/Shanghai">(GMT+8:00) Shanghai</option>
            <option value="Asia/Singapore">(GMT+8:00) Singapore</option>
            <option value="Asia/Taipei">(GMT+8:00) Taipei</option>
            <option value="Asia/Tehran">(GMT+4:30) Tehran</option>
            <option value="Asia/Tokyo">(GMT+9:00) Tokyo</option>
            <option value="Atlantic/Azores">(GMT+0:00) Azores</option>
            <option value="Atlantic/Cape_Verde">(GMT-1:00) Cape Verde</option>
            <option value="Australia/Adelaide">(GMT+9:30) Adelaide</option>
            <option value="Australia/Brisbane">(GMT+10:00) Brisbane</option>
            <option value="Australia/Darwin">(GMT+9:30) Darwin</option>
            <option value="Australia/Hobart">(GMT+10:00) Hobart</option>
            <option value="Australia/Melbourne">(GMT+10:00) Melbourne</option>
            <option value="Australia/Perth">(GMT+8:00) Perth</option>
            <option value="Australia/Sydney">(GMT+10:00) Sydney</option>
            <option value="Europe/Amsterdam">(GMT+2:00) Amsterdam</option>
            <option value="Europe/Athens">(GMT+3:00) Athens</option>
            <option value="Europe/Belgrade">(GMT+2:00) Belgrade</option>
            <option value="Europe/Berlin">(GMT+2:00) Berlin</option>
            <option value="Europe/Bratislava">(GMT+2:00) Bratislava</option>
            <option value="Europe/Brussels">(GMT+2:00) Brussels</option>
            <option value="Europe/Bucharest">(GMT+3:00) Bucharest</option>
            <option value="Europe/Budapest">(GMT+2:00) Budapest</option>
            <option value="Europe/Copenhagen">(GMT+2:00) Copenhagen</option>
            <option value="Europe/Dublin">(GMT+1:00) Dublin</option>
            <option value="Europe/Helsinki">(GMT+3:00) Helsinki</option>
            <option value="Europe/Istanbul">(GMT+3:00) Istanbul</option>
            <option value="Europe/Kiev">(GMT+3:00) Kyiv</option>
            <option value="Europe/Lisbon">(GMT+1:00) Lisbon</option>
            <option value="Europe/London">(GMT+1:00) London</option>
            <option value="Europe/Madrid">(GMT+2:00) Madrid</option>
            <option value="Europe/Malta">(GMT+2:00) Malta</option>
            <option value="Europe/Moscow">(GMT+3:00) Moscow</option>
            <option value="Europe/Oslo">(GMT+2:00) Oslo</option>
            <option value="Europe/Paris">(GMT+2:00) Paris</option>
            <option value="Europe/Prague">(GMT+2:00) Prague</option>
            <option value="Europe/Rome">(GMT+2:00) Rome</option>
            <option value="Europe/Stockholm">(GMT+2:00) Stockholm</option>
            <option value="Europe/Vienna">(GMT+2:00) Vienna</option>
            <option value="Europe/Warsaw">(GMT+2:00) Warsaw</option>
            <option value="Europe/Zurich">(GMT+2:00) Zurich</option>
            <option value="Indian/Maldives">(GMT+5:00) Maldives</option>
            <option value="Pacific/Auckland">(GMT+12:00) Auckland</option>
            <option value="Pacific/Fiji">(GMT+12:00) Fiji</option>
            <option value="Pacific/Guam">(GMT+10:00) Guam</option>
            <option value="Pacific/Honolulu">(GMT-10:00) Honolulu</option>
            <option value="Pacific/Midway">(GMT-11:00) Midway Island</option>
            <option value="Pacific/Noumea">(GMT+11:00) New Caledonia</option>
            <option value="Pacific/Pago_Pago">(GMT-11:00) Pago Pago</option>
            <option value="Pacific/Port_Moresby">(GMT+10:00) Port Moresby</option>
            <option value="Pacific/Tongatapu">(GMT+13:00) Tongatapu</option>
        </select>
    </div>
    <div class="form-group">
        <label for="startDatetime">Start Date and Time:</label>
        <input type="datetime-local" id="startDatetime" required>
    </div>
    <div class="form-group">
        <label for="endDatetime">End Date and Time:</label>
        <input type="datetime-local" id="endDatetime" required>
    </div>
    <div class="form-group">
        <label for="location">Location:</label>
        <input type="text" id="location" value="https://uni-sydney.zoom.us/my/soft.eng">
    </div>
    <div class="form-group">
        <label for="organizer">Organizer:</label>
        <input type="text" id="organizer" value="(Your email here)">
    </div>
    <div class="form-group">
        <label for="description">Description:</label>
        <textarea id="description" rows="4" cols="50"></textarea>
    </div>
    <div class="form-group">
          <label for="recurring">Recurring Event:</label>
          <input type="checkbox" id="recurring" name="recurring">
    </div>
    <div id="recurringOptions" style="display:none;">
          <div class="form-group">
              <label for="frequency">Frequency:</label>
              <select id="frequency" name="frequency">
                  <option value="DAILY">Daily</option>
                  <option value="WEEKLY" selected>Weekly</option>
                  <option value="MONTHLY">Monthly</option>
                  <option value="YEARLY">Yearly</option>
              </select>
          </div>
          <!--div class="form-group">
              <label for="interval">Interval:</label>
              <input type="number" id="interval" name="interval" min="1" value="1">
          </div>
          <div class="form-group">
              <label for="count">Number of occurrences:</label>
              <input type="number" id="count" name="count" min="1">
          </div-->
          <div class="form-group">
              <label for="until">End date:</label>
              <input type="date" id="until" name="until">
          </div>
    </div>
    <input type="submit" value="Generate ICS" style="margin: 10px 5px;">
</form>

<h3>Generated ICS Content:</h3>
<textarea id="icsOutput" rows="10" cols="70"></textarea><br>
<button onclick="copyToClipboard()">Copy</button>
<button onclick="downloadICS()">Download</button>

<script>
function setDefaultDateTimes() {
    const now = new Date();
    const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
    
    const formatDatetime = (date) => {
        return date.toLocaleString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(', ', 'T');
    };
    
    document.getElementById('startDatetime').value = formatDatetime(now);
    document.getElementById('endDatetime').value = formatDatetime(oneHourLater);
}

function setUserTimeZone() {
    const timeZoneSelect = document.getElementById('timezone');
    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    
    for (let i = 0; i < timeZoneSelect.options.length; i++) {
        if (timeZoneSelect.options[i].value === userTimeZone) {
            timeZoneSelect.selectedIndex = i;
            break;
        }
    }
    
    // If user's time zone is not found, default to Sydney
    if (timeZoneSelect.selectedIndex === 0) {
        const sydneyOption = Array.from(timeZoneSelect.options).find(option => option.value === 'Australia/Sydney');
        if (sydneyOption) {
            sydneyOption.selected = true;
        }
    }
}

function adjustTimeForTimezone() {
    const timezone = document.getElementById('timezone').value;
    const startDatetime = document.getElementById('startDatetime');
    const endDatetime = document.getElementById('endDatetime');

    if (startDatetime.value && endDatetime.value) {
        const startDate = new Date(startDatetime.value);
        const endDate = new Date(endDatetime.value);

        const formatDateForTimezone = (date, timeZone) => {
            return date.toLocaleString('en-CA', {
                timeZone: timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(', ', 'T');
        };

        startDatetime.value = formatDateForTimezone(startDate, timezone);
        endDatetime.value = formatDateForTimezone(endDate, timezone);
    }
}

function setEndDateOneYearFromStart() {
    const startDate = new Date(document.getElementById('startDatetime').value);
    const oneYearFromStart = new Date(startDate);
    oneYearFromStart.setFullYear(oneYearFromStart.getFullYear() + 1);
    const formattedDate = oneYearFromStart.toISOString().split('T')[0];
    document.getElementById('until').value = formattedDate;
}

window.onload = function() {
    setDefaultDateTimes();
    setUserTimeZone();
    document.getElementById('timezone').addEventListener('change', adjustTimeForTimezone);
    document.getElementById('recurring').addEventListener('change', function() {
        const recurringOptions = document.getElementById('recurringOptions');
        recurringOptions.style.display = this.checked ? 'block' : 'none';
        if (this.checked) {
            setEndDateOneYearFromStart();
        }
    });
    document.getElementById('startDatetime').addEventListener('change', function() {
        if (document.getElementById('recurring').checked) {
            setEndDateOneYearFromStart();
        }
    });
};

function generateICS() {
    const event_name = document.getElementById("eventName").value;
    const start_datetime_local = new Date(document.getElementById("startDatetime").value);
    const end_datetime_local = new Date(document.getElementById("endDatetime").value);
    const description = document.getElementById("description").value;
    const location = document.getElementById("location").value;
    const organizer = document.getElementById("organizer").value;
    const timezone = document.getElementById("timezone").value;

    // Recurring event options
    const isRecurring = document.getElementById("recurring").checked;
    let rrule = "";
    if (isRecurring) {
        const until = document.getElementById("until").value;
        const untilDate = new Date(until);
        const untilFormatted = untilDate.toISOString().replace(/[-:]/g, '').split('.')[0] + "Z";
        const recFrequency = document.getElementById("frequency").value;
        rrule = `RRULE:FREQ=${recFrequency};UNTIL=${untilFormatted}`;
    }

      // Parse input datetimes as being in the selected time zone
    const start_datetime = new Date(
        new Date(`${start_datetime_local}`).toLocaleString("en-US", { timeZone: timezone })
    );
    const end_datetime = new Date(
        new Date(`${end_datetime_local}`).toLocaleString("en-US", { timeZone: timezone })
    );

    // Convert to UTC and format for ICS
    const formatDatetimeUTC = (date) =>
        date.toISOString().replace(/[-:]/g, '').split('.')[0] + "Z";

    const start_datetime_utc = formatDatetimeUTC(start_datetime);
    const end_datetime_utc = formatDatetimeUTC(end_datetime);
    const dtstamp = formatDatetimeUTC(new Date());
    const uid = Date.now() + "-" + event_name.replace(/[^a-zA-Z0-9]/g, '');

    // Create the ICS content
    let ics_content = "BEGIN:VCALENDAR\r\n";
    ics_content += "VERSION:2.0\r\n";
    ics_content += "PRODID:-//University of Sydney//Software Engineering//EN\r\n";
    ics_content += "BEGIN:VTIMEZONE\r\n";
    ics_content += "TZID:" + timezone + "\r\n";
    ics_content += "END:VTIMEZONE\r\n";
    ics_content += "BEGIN:VEVENT\r\n";
    ics_content += "SUMMARY:" + event_name + "\r\n";
    ics_content += "DTSTART:" + start_datetime_utc + "\r\n";
    ics_content += "DTEND:" + end_datetime_utc + "\r\n";
    ics_content += "DTSTAMP:" + dtstamp + "\r\n";
    ics_content += "UID:" + uid + "\r\n";
    ics_content += "DESCRIPTION:" + description + "\r\n";
    ics_content += "LOCATION:" + location + "\r\n";
    ics_content += "ORGANIZER:" + organizer + "\r\n";

    if (isRecurring) {
        ics_content += rrule + "\r\n";
    }
    ics_content += "END:VEVENT\r\n";
    ics_content += "END:VCALENDAR\r\n";

    document.getElementById("icsOutput").value = ics_content;
}

function copyToClipboard() {
    const textBox = document.getElementById("icsOutput");
    textBox.select();
    document.execCommand("copy");
}

function downloadICS() {
    const ics_content = document.getElementById("icsOutput").value;
    const blob = new Blob([ics_content], { type: "text/calendar" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.style.display = "none";
    a.href = url;
    a.download = "event.ics";
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
<p>
My calendar is <a href="https://outlook.office365.com/calendar/published/fc67aa5d51784de69e3b998875dfa71a@sydney.edu.au/f628c9a3c6284a46bc91035555cc330417936987815253932396/calendar.html">here</a>. Please verify that I have a time slot available
before sending, and verify that the calendar slot shows up correctly after I accept.

</body>
</html>
